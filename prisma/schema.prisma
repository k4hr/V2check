generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Users ============
model User {
  id                String     @id @default(cuid())
  telegramId        String     @unique
  username          String?
  firstName         String?
  lastName          String?

  // --- VK (опционально) ---
  vkUserId          String?    @unique
  vkScreenName      String?
  vkPhoto           String?

  // подписка / тариф
  plan              String?
  subscriptionUntil DateTime?

  // аудит
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  lastSeenAt        DateTime?

  favorites         Favorite[]
  cases             Case[]
  payments          Payment[]
  usageDaily        UsageDaily[]

  chatThreads       ChatThread[]
  cardPayments      CardPayment[]  // <—— добавили связь
}

// ============ Суточный учёт запросов ============
model UsageDaily {
  id        String   @id @default(cuid())
  userId    String
  date      String
  used      Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
}

// ============ Favorites ============
model Favorite {
  id        String   @id @default(cuid())
  userId    String
  title     String
  url       String?
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============ Chat Threads ============
model ChatThread {
  id          String        @id @default(cuid())
  userId      String
  toolSlug    String
  title       String
  emoji       String?
  starred     Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  lastUsedAt  DateTime      @default(now())

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@index([userId, starred])
  @@index([lastUsedAt])
  @@index([updatedAt])
}

model ChatMessage {
  id         String   @id @default(cuid())
  threadId   String
  role       String
  content    String
  imagesJson String?
  createdAt  DateTime @default(now())

  thread     ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
}

// ============ Library docs ============
model Doc {
  id        String        @id @default(cuid())
  slug      String        @unique
  title     String
  category  String
  sourceUrl String?
  updatedAt DateTime      @default(now())
  createdAt DateTime      @default(now())

  versions  DocVersion[]
}

model DocVersion {
  id          String   @id @default(cuid())
  docId       String
  contentHtml String
  createdAt   DateTime @default(now())

  doc         Doc      @relation(fields: [docId], references: [id], onDelete: Cascade)

  @@index([docId])
}

// ============ Cases ============
model Case {
  id        String    @id @default(cuid())
  userId    String
  title     String
  status    String    @default("active")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  nextDueAt DateTime? @map("next_due_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CaseItem[]

  @@index([userId])
  @@index([status])
  @@index([nextDueAt])

  @@map("cases")
}

model CaseItem {
  id        String   @id @default(cuid())
  caseId    String
  kind      String
  title     String
  body      String?
  dueAt     DateTime?
  done      Boolean  @default(false)
  priority  Int?
  createdAt DateTime @default(now())

  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([kind])
  @@index([dueAt])

  @@map("case_items")
}

// ============ Payments (Stars/CRYPTO/VK/TG) ============
model Payment {
  id                      String   @id @default(cuid())
  userId                  String
  telegramId              String
  payload                 String?

  tier                    String?
  plan                    String?

  amount                  Int?
  currency                String?
  days                    Int?

  platform                String?
  provider                String?

  telegramChargeId        String?
  vkOrderId               String?
  vkAppId                 Int?
  vkPayerId               String?

  providerPaymentChargeId String?
  raw                     Json?

  createdAt               DateTime @default(now())

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([telegramId, telegramChargeId])
  @@unique([vkOrderId])
  @@index([userId])
  @@index([telegramId])
  @@index([platform])
  @@index([currency])
}

// ============ CardPayment (ЮKassa, RUB) ============
model CardPayment {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  telegramId     String?
  tier           String    // 'PRO' | 'PROPLUS'
  plan           String    // 'WEEK' | 'MONTH' | 'HALF_YEAR' | 'YEAR'
  amountKopecks  Int
  currency       String    @default("RUB")
  paymentId      String    @unique   // YooKassa payment.id
  meta           Json?

  user           User?     @relation(fields: [telegramId], references: [telegramId])
  @@index([telegramId])
  @@index([tier])
  @@index([plan])
  @@index([createdAt])
}
